<script>
  let bufferStartTime = null;

  const video = document.getElementById("player");
  const logBox = document.getElementById("log");
  const API_URL =
    "https://dunwbzjdh7.execute-api.us-east-1.amazonaws.com/events";

  function logEvent(name, extra = {}) {
    const evt = {
      event: name,
      ts: new Date().toISOString(),
      currentTime: Number(video.currentTime.toFixed(2)),
      duration: isFinite(video.duration) ? Number(video.duration.toFixed(2)) : null,
      paused: video.paused,
      ...extra,
    };

    console.log(evt);

    fetch(API_URL, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify(evt),
    }).catch(() => {});

    logBox.textContent = JSON.stringify(evt, null, 2) + "\n" + logBox.textContent;
  }

  ["play", "pause", "seeking", "seeked", "ended"].forEach((e) => {
    video.addEventListener(e, () => logEvent(e));
  });

  // Buffer start
  video.addEventListener("waiting", () => {
    bufferStartTime = performance.now();
    logEvent("buffer_start");
  });

  // Buffer end (when playback resumes)
  video.addEventListener("playing", () => {
    if (bufferStartTime !== null) {
      const bufferMs = Math.round(performance.now() - bufferStartTime);
      logEvent("buffer_end", { bufferMs });
      bufferStartTime = null;
    } else {
      logEvent("playing");
    }
  });

  video.addEventListener("error", () => {
    const err = video.error
      ? { code: video.error.code, message: video.error.message }
      : {};
    logEvent("error", err);
  });

  logEvent("page_loaded");
</script>
